import { b as browser, o, g as getAccessToken, a as getAuthLoginUrl, c as getApiServerHost, d as getAccessTokenFromCode, e as clearAccessToken, f as clearRefreshToken } from './chunks/api-d460d276.js';
import { s as serializeError } from './chunks/index-d18c5d2d.js';

/** Â© 2025, Insite Life Ltd. All rights reserved. **/
const autoOpenRegistry=new Map;function stripTrailingSlash(u){try{const url=new URL(u);return url.pathname.endsWith("/")&&"/"!==url.pathname&&(url.pathname=url.pathname.replace(/\/+$/,"")),url.toString()}catch{return u.replace(/\/+$/,"")}}function ensureTrailingSlash(u){try{const url=new URL(u);return url.pathname.endsWith("/")||(url.pathname=url.pathname+"/"),url.toString()}catch{return u.endsWith("/")?u:u+"/"}}function urlVariants(raw){const full=function(raw){try{const url="string"==typeof raw?new URL(raw):raw;return decodeURI(url.toString())}catch{return String(raw)}}(raw),base=function(u){try{const url=new URL(u);return url.search="",url.hash="",url.toString()}catch{return u}}(full),baseNoSlash=stripTrailingSlash(base),baseWithSlash=ensureTrailingSlash(base),baseNoWww=function(u){try{const url=new URL(u);return url.hostname=url.hostname.replace(/^www\./,""),url.toString()}catch{return u}}(base),baseNoWwwNoSlash=stripTrailingSlash(baseNoWww),baseNoWwwWithSlash=ensureTrailingSlash(baseNoWww);return Array.from(new Set([full,base,baseNoSlash,baseWithSlash,baseNoWww,baseNoWwwNoSlash,baseNoWwwWithSlash]))}async function updateExtensionIcon(haveNewPrompts){haveNewPrompts?await browser.action.setIcon({path:"icons/icon-notification.png"}):await browser.action.setIcon({path:{16:"icons/icon16.png",32:"icons/icon32.png",48:"icons/icon48.png",128:"icons/icon128.png"}});}async function initializeIconState(){const storage=await browser.storage.local.get("notifications.haveNewPrompts");await updateExtensionIcon(!0===storage["notifications.haveNewPrompts"]);}async function toggleNewPromptsFlag(haveNewPrompts){const STORAGE_KEY="notifications.haveNewPrompts";if((await browser.storage.local.get(STORAGE_KEY))[STORAGE_KEY]!==haveNewPrompts){await browser.storage.local.set({[STORAGE_KEY]:haveNewPrompts}),await updateExtensionIcon(haveNewPrompts);const tabs=await browser.tabs.query({});for(const tab of tabs)try{await browser.tabs.sendMessage(tab.id,{type:"notifications.haveNewPrompts.changed",haveNewPrompts});}catch(_){}}}async function networkRequest(msg){var _a;try{const host=await getApiServerHost(),authToken=await getAccessToken();msg.arguments[1]=msg.arguments[1]||{},msg.arguments[1].headers=new Headers((null===(_a=msg.arguments[1])||void 0===_a?void 0:_a.headers)||{}),msg.arguments[1].headers.set("Authorization","Bearer "+authToken),msg.arguments[1].headers.set("X-Insite-Version","1.4.27"),"string"==typeof msg.arguments[0]&&(msg.arguments[0]=new URL(msg.arguments[0],`https://${host}/`));const response=await fetch(...msg.arguments);if(401===response.status){await clearAccessToken();if(await getAccessToken())return networkRequest(msg);throw new Error(response.headers.has("www-authenticate")?response.headers.get("www-authenticate"):response.statusText)}if(200!==response.status)throw new Error(response.statusText);const text=await response.text();return {response:{status:response.status,statusText:response.statusText,headers:Object.fromEntries(response.headers.entries()),body:text}}}catch(error){return {error:serializeError(error)}}}async function goToHome(windowId){const host=await getApiServerHost();if(!windowId){windowId=(await browser.windows.getCurrent()).id;}const tabs=await browser.tabs.query({url:`https://${host}/`,windowId});return tabs.length>0?await browser.tabs.update(tabs[0].id,{active:!0}):await browser.tabs.create({url:`https://${host}/`,windowId}),!0}self.addEventListener("install",async()=>{await browser.runtime.setUninstallURL("https://www.insite.life/uninstall?utm_source=chrome%201.4.27&utm_medium=extension&utm_campaign=uninstall_survey"),await async function(){await browser.alarms.get("notifications")||browser.alarms.create("notifications",{delayInMinutes:1,periodInMinutes:1});}(),await initializeIconState();}),browser.runtime.onMessage.addListener(async(message,sender)=>{var _a,_b,_c;switch(message.type){case"announce":if(message.url){const candidates=urlVariants(message.url);for(const key of candidates)if(autoOpenRegistry.has(key)){const info=autoOpenRegistry.get(key);
// Cleanup all variants in this family
for(const k of candidates)autoOpenRegistry.delete(k);return {action:"open",includeHidden:!0===(null==info?void 0:info.includeHidden)}}}break;case"register_auto_open":if(message.url){const variants=urlVariants(message.url);for(const v of variants)autoOpenRegistry.set(v,{includeHidden:message.includeHidden});}return !0;case"login":return getAuthLoginUrl();case"fetch":return networkRequest(message.msg);case"notifications.haveNewPrompts.clear":return toggleNewPromptsFlag(!1);case"self.zoomFactor":if(null===(_a=null==sender?void 0:sender.tab)||void 0===_a?void 0:_a.id)return browser.tabs.getZoom(sender.tab.id);break;case"querySessionData":return o(await getAccessToken());case"goToHome":return goToHome(null!==(_b=message.windowId)&&void 0!==_b?_b:null===(_c=sender.tab)||void 0===_c?void 0:_c.windowId)}return !1}),browser.runtime.onMessageExternal.addListener(async(request,sender)=>{if(sender.url){if(new URL(sender.url).host!==await getApiServerHost())return !1}if("hello"===request.type)return "hello";if("oauth2"===request.type)try{return await getAccessTokenFromCode(request.code,request.state)}catch(e){console.error(e);}else if("logout"===request.type)return await clearAccessToken(),await clearRefreshToken(),!0;return !1}),browser.action.onClicked.addListener(async(tab,_info)=>{tab.url?await browser.tabs.sendMessage(tab.id,{type:"toggleSidebar"}):await goToHome(tab.windowId);}),browser.runtime.onInstalled.addListener(async details=>{"install"===details.reason&&await browser.tabs.create({url:`https://${await getApiServerHost()}/first-install`});}),self.addEventListener("activate",async()=>{await initializeIconState();const tabs=await browser.tabs.query({});for(const tab of tabs)try{await browser.scripting.executeScript({target:{tabId:tab.id},files:["import-injected.js"]});}catch(_){}}),browser.alarms.onAlarm.addListener(async alarm=>{var _a,_b,_c,_d,_e,_f,_g,_h,_j,_k,_l,_m,_o,_p,_q;if("notifications"===alarm.name){const cursor=await browser.storage.local.get("notifications.cursor");let response=await networkRequest({arguments:[`https://${await getApiServerHost()}/graphql`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:"query CurrentUser {\n              user {\n                id\n              }\n            }",variables:{}})}]}),body=JSON.parse(null!==(_b=null===(_a=response.response)||void 0===_a?void 0:_a.body)&&void 0!==_b?_b:"{}");const currentUserId=null===(_d=null===(_c=body.data)||void 0===_c?void 0:_c.user)||void 0===_d?void 0:_d.id;response=await networkRequest({arguments:[`https://${await getApiServerHost()}/graphql`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:"query NewPrompts($cursor: String, $currentUser: ID!) {\n              prompts(before: $cursor, first: 1, filters: {assignee: $currentUser}) {\n                edges {\n                  node {\n                    id\n                  }\n                }\n                pageInfo {\n                  startCursor\n                }\n              }\n            }",variables:{cursor:cursor["notifications.cursor"],currentUser:currentUserId}})}]}),body=JSON.parse(null!==(_f=null===(_e=response.response)||void 0===_e?void 0:_e.body)&&void 0!==_f?_f:"{}"),(null===(_j=null===(_h=null===(_g=body.data)||void 0===_g?void 0:_g.prompts)||void 0===_h?void 0:_h.edges)||void 0===_j?void 0:_j.length)&&await toggleNewPromptsFlag(!0),(null===(_m=null===(_l=null===(_k=body.data)||void 0===_k?void 0:_k.prompts)||void 0===_l?void 0:_l.pageInfo)||void 0===_m?void 0:_m.startCursor)&&await browser.storage.local.set({"notifications.cursor":null===(_q=null===(_p=null===(_o=body.data)||void 0===_o?void 0:_o.prompts)||void 0===_p?void 0:_p.pageInfo)||void 0===_q?void 0:_q.startCursor});}});
